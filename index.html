<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplikasi Penjamin Kualitas Maturitas SPIP</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
</head>
<body>
  <div class="container my-4">
    <h1 class="h3 text-primary">Penjamin Kualitas Maturitas Penyelenggaraan SPIP</h1>
    <p class="text-muted">Periode Penilaian: 01 Juli 2024 – 30 Juni 2025</p>

    <!-- Pilih Unit -->
    <div class="mb-3">
      <label for="satker-select" class="form-label fw-semibold">Pilih Unit Organisasi</label>
      <select id="satker-select" class="form-select">
        <option>Sestama</option>
        <option>Inspektorat</option>
      </select>
    </div>

    <!-- Contoh tabel parameter -->
    <table class="table table-bordered">
      <thead class="table-light">
        <tr><th>Kode</th><th>Uraian</th><th>Aksi</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>1.1.1</td>
          <td>K/L/D menegakkan integritas …</td>
          <td><button class="btn btn-primary btn-sm open-modal-btn" data-param="1.1.1">Isi Penilaian</button></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal Penilaian -->
  <div class="modal fade" id="assessment-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Formulir Penilaian</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <!-- Bukti Dukung (Drive) -->
          <div class="mt-3">
            <h6 class="fw-semibold">Bukti Dukung</h6>
            <p class="text-muted small">File diambil otomatis dari folder Google Drive (Grade A–E). Pastikan folder diset <em>Anyone with the link – Viewer</em>.</p>
            <div class="nav nav-pills gap-2 mb-3" id="grade-tabs">
              <button class="btn btn-primary btn-sm" data-grade="A">Grade A</button>
              <button class="btn btn-outline-primary btn-sm" data-grade="B">Grade B</button>
              <button class="btn btn-outline-primary btn-sm" data-grade="C">Grade C</button>
              <button class="btn btn-outline-primary btn-sm" data-grade="D">Grade D</button>
              <button class="btn btn-outline-primary btn-sm" data-grade="E">Grade E</button>
            </div>
            <div id="file-list" class="list-group small">
              <div class="text-muted px-2 py-1">Belum ada dokumen.</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Modal Preview -->
  <div class="modal fade" id="preview-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="preview-title">Preview Dokumen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0" style="height:80vh">
          <iframe id="preview-frame" src="" style="border:0;width:100%;height:100%"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script Google Drive API -->
  <script>
  // === API Key Google Drive ===
  const DRIVE_API_KEY = "YOUR_API_KEY_HERE"; // <-- ganti dengan API Key kamu

  // === Folder IDs (diisi dari link yang kamu kirim) ===
  const DRIVE_FOLDERS = {
    "Sestama": {
      A: "1hTPPL7emavgqqV8_hjEVCSzUQ1gYAXQP",
      B: "1_1IkaSHd_Maz8BgkzkrENz8y7OeN2lEq",
      C: "1U0u1LVwY02L3acxmQwnulxUydN3xOdpV",
      D: "1xB5XZk8fOWNvVIi8gmZmhDT9rqSYYVd1",
      E: "1IE_Z_yL7yZz16xt6KY4OQe-yUN3CP1ZG"
    },
    "Inspektorat": {
      A: "14FnnAUn-VX6XgWMxNmt8j_4Erz0KmVls",
      B: "1K9jPDEX5BA4QphqVkWqRgBJC5mwSN1JL",
      C: "1Mh0ZiUDkZ2rfmZlifCHUKwiSW-eXLsVG",
      D: "1Bk3cEUtsC3zd7u63eKGvLgh_l9_qcv0B",
      E: "1WYet_SW3uL6m8H5tIxE1b4HqTCmzvjqM"
    }
  };

  let currentUnit = "Sestama";
  let currentGrade = "A";

  // Ambil file dari folder Drive
  async function listDriveFolder(folderId) {
    const q = encodeURIComponent(`'${folderId}' in parents and trashed = false`);
    const fields = encodeURIComponent("files(id,name,mimeType,modifiedTime,webViewLink,iconLink)");
    const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=${fields}&key=${DRIVE_API_KEY}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("Drive API error");
    return (await res.json()).files || [];
  }

  function previewUrl(file) {
    const mt = file.mimeType || "";
    if (mt.includes("document"))
      return `https://docs.google.com/document/d/${file.id}/preview`;
    if (mt.includes("spreadsheet"))
      return `https://docs.google.com/spreadsheets/d/${file.id}/preview`;
    if (mt.includes("presentation"))
      return `https://docs.google.com/presentation/d/${file.id}/preview`;
    return `https://drive.google.com/file/d/${file.id}/preview`;
  }

  function renderFiles(files) {
    const listEl = document.getElementById("file-list");
    if (!files.length) {
      listEl.innerHTML = '<div class="text-muted px-2 py-1">Belum ada dokumen.</div>';
      return;
    }
    listEl.innerHTML = "";
    files.forEach((f,i) => {
      const row = document.createElement("div");
      row.className = "list-group-item d-flex justify-content-between align-items-center";
      row.innerHTML = `
        <div>
          <a href="${f.webViewLink}" target="_blank" rel="noopener">${f.name}</a>
          <span class="text-muted small">(${new Date(f.modifiedTime).toLocaleDateString()})</span>
        </div>
        <button class="btn btn-sm btn-outline-primary" data-index="${i}">Preview</button>`;
      row.querySelector("button").addEventListener("click", () => {
        document.getElementById("preview-title").textContent = f.name;
        document.getElementById("preview-frame").src = previewUrl(f);
        new bootstrap.Modal(document.getElementById("preview-modal")).show();
      });
      listEl.appendChild(row);
    });
  }

  async function loadFiles() {
    const folderId = DRIVE_FOLDERS?.[currentUnit]?.[currentGrade];
    const listEl = document.getElementById("file-list");
    if (!folderId) {
      listEl.innerHTML = '<div class="text-danger px-2 py-1">Folder belum dikonfigurasi.</div>';
      return;
    }
    listEl.innerHTML = '<div class="text-muted px-2 py-1">Memuat dari Google Drive…</div>';
    try {
      const files = await listDriveFolder(folderId);
      renderFiles(files);
    } catch(e) {
      console.error(e);
      listEl.innerHTML = '<div class="text-danger px-2 py-1">Gagal memuat file. Cek API Key & izin folder.</div>';
    }
  }

  // Event listeners
  document.getElementById("satker-select").addEventListener("change", e=>{
    currentUnit = e.target.value;
    loadFiles();
  });
  document.getElementById("grade-tabs").addEventListener("click", e=>{
    const btn = e.target.closest("button[data-grade]");
    if (!btn) return;
    currentGrade = btn.dataset.grade;
    document.querySelectorAll("#grade-tabs button").forEach(b=>{
      b.classList.toggle("btn-primary", b===btn);
      b.classList.toggle("btn-outline-primary", b!==btn);
    });
    loadFiles();
  });
  document.querySelectorAll(".open-modal-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      new bootstrap.Modal(document.getElementById("assessment-modal")).show();
      loadFiles();
    });
  });
  </script>
</body>
</html>
