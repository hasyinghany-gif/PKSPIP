<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplikasi Penjamin Kualitas Maturitas SPIP</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root { --brand: #0d6efd; }
    html, body { height: 100%; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; background:#f8f9fa; }
    .sticky-toolbar { position: sticky; top: 0; z-index: 1030; }
    .criteria-box { max-height: 180px; overflow-y: auto; }
    .form-hint { font-size:.85rem; color:#6c757d; }
    .nav-pill-grade .btn { border-radius: 999px; }
    .list-file-item:hover { background: #f8f9fb; }
    .truncate { max-width: 100%; display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:bottom; }
  </style>
</head>
<body>
  <div id="app" class="container my-4 my-md-5">

    <!-- Header -->
    <header class="card shadow-sm mb-4 border-0">
      <div class="card-body p-4">
        <h1 class="h3 fw-bold text-primary mb-1">Penjamin Kualitas Maturitas Penyelenggaraan SPIP</h1>
        <p class="text-muted mb-1">Periode Penilaian: 01 Juli 2024 s.d. 30 Juni 2025</p>
        <p class="text-muted small mb-0">KK 3.1 · Penilaian Struktur & Proses Efektivitas dan Efisiensi</p>
      </div>
    </header>

    <!-- Toolbar -->
    <div class="sticky-toolbar card shadow-sm border-0 mb-3">
      <div class="card-body d-flex flex-column flex-md-row gap-3 align-items-md-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-building text-primary"></i>
          <label for="satker-select" class="form-label fw-semibold mb-0">Pilih Unit Organisasi (Unor)</label>
        </div>
        <select id="satker-select" class="form-select flex-grow-1" aria-label="Pilih Satuan Kerja"></select>
        <div class="ms-md-auto small text-muted" id="last-saved">—</div>
      </div>
      <div class="progress rounded-0" role="progressbar" aria-label="Progress penyelesaian" aria-valuemin="0" aria-valuemax="100">
        <div id="progress-bar" class="progress-bar" style="width:0%">0%</div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loader" class="text-center p-5">
      <div class="spinner-border text-primary" role="status" aria-live="polite" aria-busy="true">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Menghubungkan ke database...</p>
      <p id="loader-tip" class="small text-muted">Pastikan Anonymous Sign-in aktif & aturan Firestore/Storage sesuai.</p>
    </div>

    <!-- Main -->
    <main id="main-content" class="d-none">
      <div class="card shadow-sm border-0">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col" class="px-3">Kode</th>
                  <th scope="col" class="px-3">Uraian Parameter</th>
                  <th scope="col" class="px-3 text-center">Status</th>
                  <th scope="col" class="px-3 text-center">Aksi</th>
                  <th scope="col" class="px-3 text-center">Grade</th>
                </tr>
              </thead>
              <tbody id="assessment-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal -->
    <div class="modal fade" id="assessment-modal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h1 class="modal-title h5" id="modalTitle">Formulir Penilaian</h1>
              <p id="modal-parameter-title" class="text-muted small mb-0"></p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
          </div>
          <div class="modal-body">
            <form id="assessment-form" novalidate>
              <input type="hidden" id="current-parameter-code" />

              <div class="mb-4">
                <h3 class="h6 fw-semibold mb-2">Kriteria Penilaian</h3>
                <div id="modal-criteria-container" class="criteria-box p-3 bg-light border rounded" aria-live="polite"></div>
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label for="metode-penilaian" class="form-label">Metode Penilaian</label>
                  <select id="metode-penilaian" class="form-select" required>
                    <option value="Wawancara">Wawancara</option>
                    <option value="Analisis Dokumen">Analisis Dokumen</option>
                    <option value="Observasi">Observasi</option>
                  </select>
                  <div class="invalid-feedback">Pilih metode penilaian.</div>
                </div>
                <div class="col-md-6">
                  <label for="simpulan" class="form-label">Simpulan Hasil Pengujian</label>
                  <select id="simpulan" class="form-select" required>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                  </select>
                  <div class="invalid-feedback">Pilih simpulan.</div>
                </div>
              </div>

              <div class="mt-3">
                <label for="hasil-pengujian" class="form-label">Uraian Kondisi Detail Hasil Pengujian</label>
                <textarea id="hasil-pengujian" rows="4" class="form-control" placeholder="Jelaskan kondisi detail hasil pengujian..." required></textarea>
                <div class="invalid-feedback">Mohon isi uraian hasil pengujian.</div>
              </div>

              <div class="mt-3">
                <label for="uraian-aoi" class="form-label">Uraian AoI (Area of Improvement)</label>
                <textarea id="uraian-aoi" rows="3" class="form-control" placeholder="Jelaskan area yang perlu perbaikan..." required></textarea>
                <div class="invalid-feedback">Mohon isi uraian AoI.</div>
              </div>

              <!-- === FIELD KHUSUS SESTAMA === -->
              <hr class="my-4">
              <div id="sestama-fields" class="d-none">
                <p class="form-hint mb-2"><i class="bi bi-info-circle"></i> Bidang berikut khusus untuk <strong>Sestama</strong>.</p>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="simpulan-sestama" class="form-label">Simpulan Hasil Pengujian (Sestama)</label>
                    <select id="simpulan-sestama" class="form-select">
                      <option value="">— Pilih —</option>
                      <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label for="hasil-pengujian-sestama" class="form-label">Uraian Kondisi Detail Hasil Pengujian (Sestama)</label>
                    <textarea id="hasil-pengujian-sestama" rows="3" class="form-control" placeholder="Isikan uraian milik Sestama untuk dijadikan rujukan Unor lain..."></textarea>
                  </div>
                </div>
              </div>

              <!-- === RUJUKAN SESTAMA (read-only untuk Unor ≠ Sestama) === -->
              <div id="sestama-reference" class="mt-4 d-none">
                <div class="card border-0 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <i class="bi bi-journal-text text-primary"></i>
                      <strong>Rujukan (Sestama)</strong>
                    </div>
                    <dl class="row mb-0">
                      <dt class="col-sm-4">Simpulan Sestama</dt>
                      <dd class="col-sm-8" id="ref-simpulan-sestama">—</dd>
                      <dt class="col-sm-4">Uraian Sestama</dt>
                      <dd class="col-sm-8" id="ref-uraian-sestama"><span class="text-muted">Tidak ada rujukan</span></dd>
                    </dl>
                  </div>
                </div>
              </div>

              <!-- === BUKTI DUKUNG (UPLOAD ke Firebase Storage) === -->
              <div class="mt-4">
                <h3 class="h6 fw-semibold mb-2">Bukti Dukung</h3>
                <p class="text-muted small mb-3">Unggah dokumen pendukung per grade. Klik nama dokumen untuk membuka di tab baru.</p>
                <div class="nav nav-pill-grade gap-2 mb-3" id="grade-tabs">
                  <button type="button" class="btn btn-primary btn-sm" data-grade="A">Grade A</button>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-grade="B">Grade B</button>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-grade="C">Grade C</button>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-grade="D">Grade D</button>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-grade="E">Grade E</button>
                </div>

                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <input id="file-input" type="file" class="d-none" multiple />
                      <button type="button" id="btn-upload" class="btn btn-primary btn-sm">
                        <i class="bi bi-upload me-1"></i> Unggah Dokumen
                      </button>
                      <button type="button" id="btn-refresh" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-repeat me-1"></i> Segarkan
                      </button>
                      <div id="upload-status" class="small text-muted ms-auto"></div>
                    </div>
                    <div id="file-list" class="list-group list-group-flush small" style="min-height:3rem">
                      <div class="text-muted px-2 py-1">Memuat…</div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- === /BUKTI DUKUNG === -->

            </form>
          </div>
          <div class="modal-footer">
            <button type="button" id="cancel-btn" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="submit" form="assessment-form" class="btn btn-primary">
              <span class="me-1" aria-hidden="true">💾</span> Simpan
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Firebase + App Script -->
  <script type="module">
    // === Firebase Config (storageBucket diperbaiki) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCYwuJHeL_YlyW7zPNRGSXe_NB8r_Ql_t0",
      authDomain: "spip-8e5e9.firebaseapp.com",
      projectId: "spip-8e5e9",
      storageBucket: "spip-8e5e9.appspot.com",
      messagingSenderId: "448004404076",
      appId: "1:448004404076:web:6aa65c8de90439285db949",
      measurementId: "G-J44L941K89"
    };

    // Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Data (dipersingkat)
    const SATKER_LIST = ['Inspektorat', 'Pusdatin', 'Sestama', 'D1', 'D3', 'Puslat', 'D4'];
    const ASSESSMENT_STRUCTURE = [
      { kode:"1.1.1", uraian_subunsur:"Penegakan Integritas dan Nilai Etika", no:"1",
        uraian_parameter:"K/L/D menegakkan integritas dan nilai etika dalam melaksanakan tugas dan fungsi organisasi",
        kode_parameter:"1.1.1",
        grades:[
          {grade:'A',kriteria:'Penegakan integritas ...', tooltip:'Lampiran 1.1.1-A'},
          {grade:'B',kriteria:'Kebijakan & implementasi ...', tooltip:'Lampiran 1.1.1-B'},
          {grade:'C',kriteria:'Penegakan ... dilaksanakan ...', tooltip:'Lampiran 1.1.1-C'},
          {grade:'D',kriteria:'Kebijakan ... dipahami ...', tooltip:'Lampiran 1.1.1-D'},
          {grade:'E',kriteria:'Terdapat kebijakan ...', tooltip:'Lampiran 1.1.1-E'}
        ]},
      { kode:"1.2.1", uraian_subunsur:"Komitmen terhadap Kompetensi", no:"2",
        uraian_parameter:"Tugas dan jabatan dalam organisasi dilaksanakan dan diisi oleh SDM yang kompeten.",
        kode_parameter:"1.2.1",
        grades:[
          {grade:'A',kriteria:'Pengelolaan kompetensi ...', tooltip:'Lampiran 1.2.1-A'},
          {grade:'B',kriteria:'Standar kompetensi ... dievaluasi ...', tooltip:'Lampiran 1.2.1-B'},
          {grade:'C',kriteria:'Standar kompetensi diimplementasikan ...', tooltip:'Lampiran 1.2.1-C'},
          {grade:'D',kriteria:'Standar kompetensi dikomunikasikan ...', tooltip:'Lampiran 1.2.1-D'},
          {grade:'E',kriteria:'Terdapat standar kompetensi ...', tooltip:'Lampiran 1.2.1-E'}
        ]},
      { kode:"1.3.1", uraian_subunsur:"Kepemimpinan yang Kondusif", no:"1",
        uraian_parameter:"Pimpinan K/L/D menciptakan lingkungan kerja yang kondusif ...",
        kode_parameter:"1.3.1",
        grades:[
          {grade:'A',kriteria:'Penerapan manajemen kinerja ...', tooltip:'Lampiran 1.3.1-A'},
          {grade:'B',kriteria:'Evaluasi berkala ...', tooltip:'Lampiran 1.3.1-B'},
          {grade:'C',kriteria:'Pelaksanaan kebijakan ...', tooltip:'Lampiran 1.3.1-C'},
          {grade:'D',kriteria:'Keterlibatan pimpinan ...', tooltip:'Lampiran 1.3.1-D'},
          {grade:'E',kriteria:'Penyusunan kebijakan ...', tooltip:'Lampiran 1.3.1-E'}
        ]}
    ];

    // Helpers
    const $ = (sel) => document.querySelector(sel);

    const App = {
      db:null, auth:null, storage:null,
      userId:null,
      currentSatker: localStorage.getItem('spip.currentSatker') || SATKER_LIST[0],
      assessmentData:{}, unsubscribe:null, bootstrapModal:null,
      currentGrade:'A',

      init() {
        try {
          const app = initializeApp(firebaseConfig);
          this.db = getFirestore(app);
          enableIndexedDbPersistence(this.db).catch(()=>{});
          this.storage = getStorage(app);       // Storage aktif
          this.auth = getAuth(app);
          this.handleAuthentication();
        } catch (e) {
          console.error('Firebase init failed:', e);
          $('#loader').innerText = 'Kunci Firebase salah. Mohon periksa kembali.';
          return;
        }
        this.populateSatkerSelect();
        this.setupEventListeners();
        this.bootstrapModal = new bootstrap.Modal($('#assessment-modal'));
      },

      handleAuthentication() {
        onAuthStateChanged(this.auth, async (user)=>{
          if (user) {
            this.userId = user.uid;
            this.loadInitialData();
          } else {
            try { await signInAnonymously(this.auth); }
            catch(e){ console.error('Auth failed:', e); $('#loader').innerText='Gagal otentikasi. Aktifkan login anonim.'; }
          }
        });
      },

      loadInitialData(){
        $('#loader').style.display='none';
        $('#main-content').classList.remove('d-none');
        this.renderTable();
        this.listenForDataChanges();
        this.updateProgress();
      },

      populateSatkerSelect(){
        const select=$('#satker-select'); select.innerHTML='';
        SATKER_LIST.forEach(s=>{
          const opt=new Option(s,s); if(s===this.currentSatker) opt.selected=true; select.add(opt);
        });
      },

      gradeBadgeClass(g){
        return g==='A'?'success':g==='B'?'primary':g==='C'?'info':g==='D'?'warning':g==='E'?'danger':'secondary';
      },

      renderTable(){
        const tbody=$('#assessment-table-body'); tbody.innerHTML='';
        ASSESSMENT_STRUCTURE.forEach(p=>{
          const data = this.assessmentData[p.kode_parameter];
          const done = Boolean(data && data.simpulan);
          const simpulan = done ? data.simpulan : null;
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td class="px-3">${p.kode_parameter}</td>
            <td class="px-3">${p.uraian_parameter}</td>
            <td class="px-3 text-center"><span class="badge rounded-pill ${done?'text-bg-success':'text-bg-warning'}">${done?'Selesai':'Belum Diisi'}</span></td>
            <td class="px-3 text-center"><button data-param-code="${p.kode_parameter}" type="button" data-action="open-modal" class="btn btn-primary btn-sm open-modal-btn">${done?'Edit':'Isi Penilaian'}</button></td>
            <td class="px-3 text-center">${simpulan?`<span class="badge text-bg-${this.gradeBadgeClass(simpulan)}">${simpulan}</span>`:'<span class="text-muted">-</span>'}</td>`;
          tbody.appendChild(tr);
        });
      },

      listenForDataChanges(){
        if(this.unsubscribe) this.unsubscribe();
        const docRef=doc(this.db,'assessments',this.currentSatker);
        this.unsubscribe = onSnapshot(docRef,(snap)=>{
          if(snap.exists()){
            const raw=snap.data();
            this.assessmentData = raw?.parameters || {};
            this.updateLastSaved(raw?.updated_at || null);
          }else{
            this.assessmentData={}; this.updateLastSaved(null);
          }
          this.renderTable(); this.updateProgress();
        },(err)=>{
          console.error('onSnapshot error:',err);
          $('#loader').style.display='block';
          $('#loader').innerHTML=`<div class="alert alert-danger" role="alert">Gagal mengambil data. Periksa aturan keamanan Firestore Anda.</div>`;
        });
      },

      setupEventListeners(){
        $('#satker-select').addEventListener('change',(e)=>{
          this.currentSatker=e.target.value; localStorage.setItem('spip.currentSatker',this.currentSatker);
          this.listenForDataChanges();
        });

        // Delegasi event global agar listener tidak hilang saat tabel di-render ulang
        document.addEventListener('click', async (e)=>{
          const btn = e.target.closest('[data-action="open-modal"]');
          if(!btn) return;
          e.preventDefault();
          try { await this.openModal(btn.getAttribute('data-param-code')); }
          catch(err){ console.error('openModal failed', err); }
        }); if(btn) await this.openModal(btn.dataset.paramCode);
        });

        document.getElementById('assessment-form').addEventListener('submit', async (e)=>{
          e.preventDefault(); const f=e.currentTarget;
          if(!f.checkValidity()){ f.classList.add('was-validated'); return; }
          await this.saveAssessment();
        });

        // Bukti Dukung: tombol upload & refresh, tab grade
        document.getElementById('btn-upload').addEventListener('click', ()=> document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', (e)=> this.uploadFiles(e.target.files));
        document.getElementById('btn-refresh').addEventListener('click', ()=> this.refreshFiles());
        document.getElementById('grade-tabs').addEventListener('click', (e)=>{
          const btn=e.target.closest('button[data-grade]'); if(!btn) return;
          this.switchGrade(btn.dataset.grade);
        });
        document.getElementById('file-list').addEventListener('click', async (e)=>{
          const del=e.target.closest('[data-action="delete"][data-path]'); if(!del) return;
          await this.deleteFile(del.dataset.path);
        });
      },

      async openModal(paramCode){
        const param = ASSESSMENT_STRUCTURE.find(p=>p.kode_parameter===paramCode); if(!param) return;
        document.getElementById('current-parameter-code').value=paramCode;
        document.getElementById('modal-parameter-title').textContent=`${param.kode_parameter} — ${param.uraian_parameter}`;

        // Render kriteria + tooltip
        const html = param.grades.map(g=>`
          <p class="mb-1 small">
            <strong class="fw-semibold text-body-secondary">Grade ${g.grade}:</strong>
            ${g.kriteria}
            <button type="button" class="btn btn-link btn-sm p-0 align-baseline ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="${g.tooltip || 'yang terlampir sebagai berikut'}" aria-label="Info kriteria grade ${g.grade}">
              <i class="bi bi-info-circle"></i>
            </button>
          </p>`).join('');
        document.getElementById('modal-criteria-container').innerHTML=html;
        document.querySelectorAll('#assessment-modal [data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

        // Prefill field umum
        const exist = this.assessmentData[paramCode] || {};
        document.getElementById('metode-penilaian').value = exist.metode_penilaian || 'Wawancara';
        document.getElementById('simpulan').value = exist.simpulan || 'A';
        document.getElementById('hasil-pengujian').value = exist.hasil_pengujian || '';
        document.getElementById('uraian-aoi').value = exist.uraian_aoi || '';

        // Sestama fields / reference
        const isSestama = this.currentSatker === 'Sestama';
        const sestamaFields = document.getElementById('sestama-fields');
        const refCard = document.getElementById('sestama-reference');
        if (isSestama) {
          sestamaFields.classList.remove('d-none'); refCard.classList.add('d-none');
          document.getElementById('simpulan-sestama').value = exist.simpulan_sestama || '';
          document.getElementById('hasil-pengujian-sestama').value = exist.hasil_pengujian_sestama || '';
        } else {
          sestamaFields.classList.add('d-none'); refCard.classList.remove('d-none');
          try {
            const sDoc = await getDoc(doc(this.db,'assessments','Sestama'));
            const ref = sDoc.exists() ? (sDoc.data().parameters?.[paramCode] || {}) : {};
            document.getElementById('ref-simpulan-sestama').textContent = ref.simpulan_sestama || ref.simpulan || '—';
            document.getElementById('ref-uraian-sestama').textContent = ref.hasil_pengujian_sestama || ref.hasil_pengujian || 'Tidak ada rujukan';
          } catch(err){
            document.getElementById('ref-simpulan-sestama').textContent='—';
            document.getElementById('ref-uraian-sestama').innerHTML='<span class="text-danger">Gagal memuat rujukan Sestama</span>';
            console.error(err);
          }
        }

        // Bukti Dukung: reset ke Grade A & load list
        this.resetGradeTabs('A');
        this.currentGrade='A';
        await this.refreshFiles();

        this.bootstrapModal.show();
      },

      async saveAssessment(){
        const paramCode=document.getElementById('current-parameter-code').value;
        const payload={
          metode_penilaian: document.getElementById('metode-penilaian').value,
          simpulan: document.getElementById('simpulan').value,
          hasil_pengujian: document.getElementById('hasil-pengujian').value.trim(),
          uraian_aoi: document.getElementById('uraian-aoi').value.trim()
        };
        if (this.currentSatker==='Sestama') {
          payload.simpulan_sestama = document.getElementById('simpulan-sestama').value || '';
          payload.hasil_pengujian_sestama = document.getElementById('hasil-pengujian-sestama').value.trim();
        }
        const docRef=doc(this.db,'assessments',this.currentSatker);
        try{
          await setDoc(docRef, { parameters:{ [paramCode]: { ...(this.assessmentData[paramCode]||{}), ...payload } }, updated_at:new Date().toISOString() }, { merge:true });
          this.bootstrapModal.hide();
        }catch(e){ console.error('save error',e); alert('Gagal menyimpan data. Cek aturan Firestore.'); }
      },

      // ====== BUKTI DUKUNG (Storage) ======
      gradePath(grade){
        const code=document.getElementById('current-parameter-code').value;
        return `attachments/${this.currentSatker}/${code}/${grade}/`;
      },

      resetGradeTabs(active){
        document.querySelectorAll('#grade-tabs [data-grade]').forEach(btn=>{
          const isActive = btn.dataset.grade===active;
          btn.classList.toggle('btn-primary', isActive);
          btn.classList.toggle('btn-outline-primary', !isActive);
        });
      },

      switchGrade(grade){
        this.currentGrade = grade;
        this.resetGradeTabs(grade);
        this.refreshFiles();
      },

      async refreshFiles(){
        const listEl = document.getElementById('file-list');
        listEl.innerHTML = '<div class="text-muted px-2 py-1">Memuat…</div>';
        const path = this.gradePath(this.currentGrade);
        try{
          const res = await listAll(sRef(this.storage, path));
          if(!res.items.length){
            listEl.innerHTML = '<div class="text-muted px-2 py-1">Belum ada dokumen.</div>';
            return;
          }
          listEl.innerHTML = '';
          for (const item of res.items){
            const url = await getDownloadURL(item);
            const name = item.name;
            const row = document.createElement('div');
            row.className = 'list-group-item d-flex align-items-center justify-content-between list-file-item';
            row.innerHTML = `
              <a href="${url}" target="_blank" rel="noopener" class="truncate text-decoration-none">${name}</a>
              <button class="btn btn-sm btn-link text-danger" data-action="delete" data-path="${item.fullPath}"><i class="bi bi-trash"></i></button>`;
            listEl.appendChild(row);
          }
        }catch(err){
          console.error(err);
          listEl.innerHTML = '<div class="text-danger px-2 py-1">Gagal memuat daftar dokumen. Periksa aturan Storage.</div>';
        }
      },

      async uploadFiles(fileList){
        if(!fileList || !fileList.length) return;
        const status = document.getElementById('upload-status');
        const basePath = this.gradePath(this.currentGrade);
        try{
          for (const f of fileList){
            status.textContent = `Mengunggah: ${f.name}…`;
            const filename = `${Date.now()}_${f.name}`;
            await uploadBytes(sRef(this.storage, basePath + filename), f);
          }
          status.textContent = 'Unggah selesai.';
          await this.refreshFiles();
          document.getElementById('file-input').value = '';
        }catch(err){
          console.error('upload error', err);
          status.textContent = 'Gagal unggah. Cek aturan Storage.';
        }finally{
          setTimeout(()=> status.textContent='', 2500);
        }
      },

      async deleteFile(path){
        if(!confirm('Hapus dokumen ini?')) return;
        try{
          await deleteObject(sRef(this.storage, path));
          await this.refreshFiles();
        }catch(err){
          console.error('delete error', err);
          alert('Gagal menghapus. Periksa aturan Storage.');
        }
      },

      updateProgress(){
        const total = ASSESSMENT_STRUCTURE.length;
        const done = Object.values(this.assessmentData||{}).filter(v=>v && v.simpulan).length;
        const pct = Math.round((done/Math.max(1,total))*100);
        const bar = document.getElementById('progress-bar');
        bar.style.width = pct + '%';
        bar.textContent = pct + '%';
        bar.setAttribute('aria-valuenow', pct);
      },

      updateLastSaved(ts){
        const el = document.getElementById('last-saved');
        if(!ts){ el.textContent = '—'; return; }
        try{
          const dt = new Date(ts);
          el.textContent = `Terakhir disimpan: ${dt.toLocaleString()}`;
        }catch{ el.textContent='—'; }
      }
    };

    // Start app
    window.addEventListener('DOMContentLoaded', ()=> App.init());
  </script>
</body>
</html>
