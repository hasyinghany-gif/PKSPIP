<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplikasi Penjamin Kualitas Maturitas SPIP</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root { --brand: #0d6efd; }
    html, body { height: 100%; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; background:#f8f9fa; }
    .sticky-toolbar { position: sticky; top: 0; z-index: 1030; }
    .criteria-box { max-height: 180px; overflow-y: auto; }
    .form-hint { font-size:.85rem; color:#6c757d; }
    .nav-pill-grade .btn { border-radius: 999px; }
    .list-file-item:hover { background: #f8f9fb; }
    .truncate { max-width: 100%; display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:bottom; }
    .muted { color:#6c757d; }
  </style>
</head>
<body>
  <div id="app" class="container my-4 my-md-5">

    <!-- Header -->
    <header class="card shadow-sm mb-4 border-0">
      <div class="card-body p-4">
        <h1 class="h3 fw-bold text-primary mb-1">Penjamin Kualitas Maturitas Penyelenggaraan SPIP</h1>
        <p class="text-muted mb-1">Periode Penilaian: 01 Juli 2024 s.d. 30 Juni 2025</p>
        <p class="text-muted small mb-0">KK 3.1 · Penilaian Struktur & Proses Efektivitas dan Efisiensi</p>
      </div>
    </header>

    <!-- Toolbar -->
    <div class="sticky-toolbar card shadow-sm border-0 mb-3">
      <div class="card-body d-flex flex-column flex-md-row gap-3 align-items-md-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-building text-primary"></i>
          <label for="satker-select" class="form-label fw-semibold mb-0">Pilih Unit Organisasi (Unor)</label>
        </div>
        <select id="satker-select" class="form-select flex-grow-1" aria-label="Pilih Satuan Kerja"></select>
        <div class="ms-md-auto small text-muted" id="last-saved">—</div>
      </div>
      <div class="progress rounded-0" role="progressbar" aria-label="Progress penyelesaian" aria-valuemin="0" aria-valuemax="100">
        <div id="progress-bar" class="progress-bar" style="width:0%">0%</div>
      </div>
    </div>

    <!-- Main -->
    <main id="main-content" class="d-none">
      <div class="card shadow-sm border-0">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col" class="px-3">Kode</th>
                  <th scope="col" class="px-3">Uraian Parameter</th>
                  <th scope="col" class="px-3 text-center">Status</th>
                  <th scope="col" class="px-3 text-center">Aksi</th>
                  <th scope="col" class="px-3 text-center">Grade</th>
                </tr>
              </thead>
              <tbody id="assessment-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal -->
    <div class="modal fade" id="assessment-modal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h1 class="modal-title h5" id="modalTitle">Formulir Penilaian</h1>
              <p id="modal-parameter-title" class="text-muted small mb-0"></p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
          </div>
          <div class="modal-body">
            <form id="assessment-form" novalidate>
              <input type="hidden" id="current-parameter-code" />

              <!-- Form fields tetap sama (metode penilaian, simpulan, uraian, dll.) -->

              <!-- === BUKTI DUKUNG === -->
              <div class="mt-4">
                <h3 class="h6 fw-semibold mb-2">Bukti Dukung</h3>
                <p class="text-muted small mb-3">Dokumen per grade ditarik otomatis dari folder Google Drive.</p>
                <div class="nav nav-pill-grade gap-2 mb-3" id="grade-tabs">
                  <button type="button" class="btn btn-primary btn-sm" data-grade="A">Grade A</button>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-grade="B">Grade B</button>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-grade="C">Grade C</button>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-grade="D">Grade D</button>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-grade="E">Grade E</button>
                </div>

                <div class="card">
                  <div class="card-body">
                    <div id="file-list" class="list-group list-group-flush small" style="min-height:3rem">
                      <div class="text-muted px-2 py-1">Belum ada dokumen.</div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- === /BUKTI DUKUNG === -->

            </form>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- App Script -->
  <script>
  const SATKER_LIST = ['Inspektorat', 'Pusdatin', 'Sestama', 'D1', 'D3', 'Puslat', 'D4'];

  const DRIVE_API_KEY = "YOUR_API_KEY_HERE";
  const DRIVE_FOLDERS = {
    "Sestama": {
      A: "1hTPPL7emavgqqV8_hjEVCSzUQ1gYAXQP",
      B: "1_1IkaSHd_Maz8BgkzkrENz8y7OeN2lEq",
      C: "1U0u1LVwY02L3acxmQwnulxUydN3xOdpV",
      D: "1xB5XZk8fOWNvVIi8gmZmhDT9rqSYYVd1",
      E: "1IE_Z_yL7yZz16xt6KY4OQe-yUN3CP1ZG"
    },
    "Inspektorat": {
      A: "14FnnAUn-VX6XgWMxNmt8j_4Erz0KmVls",
      B: "1K9jPDEX5BA4QphqVkWqRgBJC5mwSN1JL",
      C: "1Mh0ZiUDkZ2rfmZlifCHUKwiSW-eXLsVG",
      D: "1Bk3cEUtsC3zd7u63eKGvLgh_l9_qcv0B",
      E: "1WYet_SW3uL6m8H5tIxE1b4HqTCmzvjqM"
    },
    "Pusdatin": { A:"dummy1", B:"dummy2", C:"dummy3", D:"dummy4", E:"dummy5" },
    "D1": { A:"dummy6", B:"dummy7", C:"dummy8", D:"dummy9", E:"dummy10" },
    "D3": { A:"dummy11", B:"dummy12", C:"dummy13", D:"dummy14", E:"dummy15" },
    "Puslat": { A:"dummy16", B:"dummy17", C:"dummy18", D:"dummy19", E:"dummy20" },
    "D4": { A:"dummy21", B:"dummy22", C:"dummy23", D:"dummy24", E:"dummy25" }
  };

  let currentSatker = SATKER_LIST[0];
  let currentGrade = "A";

  function previewUrl(file) {
    const mt = file.mimeType || "";
    if (mt.includes("document"))
      return `https://docs.google.com/document/d/${file.id}/preview`;
    if (mt.includes("spreadsheet"))
      return `https://docs.google.com/spreadsheets/d/${file.id}/preview`;
    if (mt.includes("presentation"))
      return `https://docs.google.com/presentation/d/${file.id}/preview`;
    return `https://drive.google.com/file/d/${file.id}/preview`;
  }

  async function listDriveFolder(folderId) {
    const q = encodeURIComponent(`'${folderId}' in parents and trashed = false`);
    const fields = encodeURIComponent("files(id,name,mimeType,modifiedTime,webViewLink)");
    const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=${fields}&key=${DRIVE_API_KEY}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("Drive API error");
    return (await res.json()).files || [];
  }

  async function refreshFiles(){
    const listEl = document.getElementById('file-list');
    const folderId = DRIVE_FOLDERS?.[currentSatker]?.[currentGrade];
    if (!folderId || folderId.startsWith("dummy")) {
      listEl.innerHTML = '<div class="text-danger px-2 py-1">Folder Google Drive belum dikonfigurasi.</div>';
      return;
    }
    listEl.innerHTML = '<div class="muted px-2 py-1">Memuat dari Google Drive…</div>';
    try {
      const files = await listDriveFolder(folderId);
      if (!files.length) {
        listEl.innerHTML = '<div class="muted px-2 py-1">Belum ada dokumen.</div>';
        return;
      }
      listEl.innerHTML = '';
      files.forEach(f => {
        const row = document.createElement('div');
        row.className = 'list-group-item d-flex justify-content-between align-items-center';
        row.innerHTML = `
          <div>
            <a href="${f.webViewLink}" target="_blank" rel="noopener">${f.name}</a>
            <span class="text-muted small"> (${new Date(f.modifiedTime).toLocaleDateString()})</span>
          </div>
          <button class="btn btn-sm btn-outline-primary">Preview</button>`;
        row.querySelector('button').addEventListener('click', ()=>{
          const frame = `<iframe src="${previewUrl(f)}" style="border:0;width:100%;height:80vh"></iframe>`;
          const modalHtml = `
            <div class="modal fade" id="preview-modal" tabindex="-1">
              <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">${f.name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body p-0">${frame}</div>
                </div>
              </div>
            </div>`;
          document.body.insertAdjacentHTML('beforeend', modalHtml);
          new bootstrap.Modal(document.getElementById('preview-modal')).show();
        });
        listEl.appendChild(row);
      });
    } catch(err) {
      console.error(err);
      listEl.innerHTML = '<div class="text-danger px-2 py-1">Gagal memuat dokumen dari Google Drive.</div>';
    }
  }

  // Event
  document.addEventListener("DOMContentLoaded", ()=>{
    const select = document.getElementById("satker-select");
    SATKER_LIST.forEach(s=>{
      const opt = new Option(s,s);
      select.add(opt);
    });
    select.value = currentSatker;
    select.addEventListener("change", e=>{
      currentSatker = e.target.value;
      refreshFiles();
    });

    document.getElementById("grade-tabs").addEventListener("click", e=>{
      const btn = e.target.closest("button[data-grade]");
      if(!btn) return;
      currentGrade = btn.dataset.grade;
      document.querySelectorAll("#grade-tabs button").forEach(b=>{
        b.classList.toggle("btn-primary", b===btn);
        b.classList.toggle("btn-outline-primary", b!==btn);
      });
      refreshFiles();
    });

    // contoh: tampilkan modal pertama kali klik tabel
    document.getElementById("assessment-table-body").innerHTML = `
      <tr>
        <td>1.1.1</td>
        <td>Contoh Parameter</td>
        <td class="text-center"><span class="badge bg-warning">Belum Diisi</span></td>
        <td class="text-center"><button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#assessment-modal">Isi Penilaian</button></td>
        <td class="text-center">-</td>
      </tr>`;
  });
  </script>
</body>
</html>
