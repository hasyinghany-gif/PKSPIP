<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Grade SPIP â€” Interaktif</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background:#f8fafc; }
    .card { border:0; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
    .sticky-topbar { position: sticky; top: 0; z-index: 1000; background: #fff; border-bottom: 1px solid #eaecef; }
    .kpi { display:flex; align-items:center; gap:.75rem; }
    .kpi .num { font-size:1.4rem; font-weight:700; }
    .kpi .trend-up { color:#16a34a; }
    .kpi .trend-down { color:#dc2626; }
    .table thead th { white-space:nowrap; }
    .toolbar .btn { white-space:nowrap; }
    .chart-card { min-height: 360px; }
    .badge.grade-a{background:#22c55e} .badge.grade-b{background:#a3e635;color:#111}
    .badge.grade-c{background:#facc15;color:#111} .badge.grade-d{background:#fb923c}
    .badge.grade-e{background:#ef4444}
  </style>
</head>
<body>
  <div class="sticky-topbar py-2">
    <div class="container d-flex align-items-center justify-content-between">
      <h6 class="mb-0">ðŸ“Š Dashboard Grade SPIP â€” Interaktif</h6>
      <div class="toolbar d-flex align-items-center gap-2">
        <input id="searchUnit" class="form-control form-control-sm" placeholder="Cari unit..." style="width:220px">
        <select id="filterCluster" class="form-select form-select-sm" style="width:180px">
          <option value="">Filter: Semua</option>
          <option value="AC">Kelompok Aâ€“C (baik)</option>
          <option value="DE">Kelompok Dâ€“E (butuh perbaikan)</option>
        </select>
        <button id="btn-refresh" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-clockwise me-1"></i>Refresh</button>
        <button id="btn-export-csv" class="btn btn-sm btn-outline-success"><i class="bi bi-filetype-csv me-1"></i>Export CSV</button>
        <button id="btn-export-png" class="btn btn-sm btn-outline-primary"><i class="bi bi-image me-1"></i>Export Grafik</button>
      </div>
    </div>
  </div>

  <div class="container my-3">
    <div class="row g-3">
      <!-- KPIs -->
      <div class="col-12 col-lg-3">
        <div class="card">
          <div class="card-body kpi">
            <i class="bi bi-diagram-3 fs-3 text-secondary"></i>
            <div>
              <div class="text-muted small">Jumlah Unit</div>
              <div class="num" id="kpi-units">0</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="card">
          <div class="card-body kpi">
            <span class="badge grade-a">A</span>
            <span class="badge grade-b">B</span>
            <span class="badge grade-c">C</span>
            <div>
              <div class="text-muted small">% Aâ€“C</div>
              <div class="num text-success" id="kpi-ac">0%</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="card">
          <div class="card-body kpi">
            <span class="badge grade-d">D</span>
            <span class="badge grade-e">E</span>
            <div>
              <div class="text-muted small">% Dâ€“E</div>
              <div class="num text-danger" id="kpi-de">0%</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-3">
        <div class="card">
          <div class="card-body kpi">
            <i class="bi bi-clock fs-3 text-secondary"></i>
            <div>
              <div class="text-muted small">Terakhir diperbarui</div>
              <div class="num" id="kpi-updated">â€”</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="col-12 col-lg-6">
        <div class="card chart-card">
          <div class="card-header bg-white"><strong>Distribusi Grade per Unit</strong></div>
          <div class="card-body"><canvas id="stackedChart"></canvas></div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card chart-card">
          <div class="card-header bg-white"><strong>Komposisi Keseluruhan</strong></div>
          <div class="card-body"><canvas id="donutChart"></canvas></div>
        </div>
      </div>

      <!-- Table -->
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle" id="tbl">
                <thead class="table-light">
                  <tr>
                    <th data-sort="text" style="width:30%">Unit Organisasi</th>
                    <th class="text-center" data-sort="num">A</th>
                    <th class="text-center" data-sort="num">B</th>
                    <th class="text-center" data-sort="num">C</th>
                    <th class="text-center" data-sort="num">D</th>
                    <th class="text-center" data-sort="num">E</th>
                    <th class="text-center" data-sort="num">Total</th>
                    <th class="text-center" data-sort="num">% Aâ€“C</th>
                    <th class="text-center" data-sort="num">% Dâ€“E</th>
                  </tr>
                </thead>
                <tbody id="dash-body"></tbody>
                <tfoot class="table-light">
                  <tr>
                    <th class="text-end">Total</th>
                    <th class="text-center" id="tA">0</th>
                    <th class="text-center" id="tB">0</th>
                    <th class="text-center" id="tC">0</th>
                    <th class="text-center" id="tD">0</th>
                    <th class="text-center" id="tE">0</th>
                    <th class="text-center" id="tT">0</th>
                    <th class="text-center" id="tAC">0%</th>
                    <th class="text-center" id="tDE">0%</th>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="text-muted small">Tip: ketik nama unit di kotak "Cari unit..." untuk memfilter.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let stackedChart, donutChart;

    function readData(){
      const raw = localStorage.getItem('gradeDashboardData') || '{}';
      const data = JSON.parse(raw);
      return data;
    }

    function compute(data){
      const rows = [];
      let sums = {A:0,B:0,C:0,D:0,E:0,T:0};
      let lastUpdated = '-';
      Object.keys(data).forEach(name => {
        const d = data[name] || {counts:{}, total:0};
        const A=d.counts.A||0, B=d.counts.B||0, C=d.counts.C||0, D=d.counts.D||0, E=d.counts.E||0;
        const T = A+B+C+D+E || d.total || 0;
        const pctAC = T? Math.round((A+B+C)/T*100) : 0;
        const pctDE = T? Math.round((D+E)/T*100) : 0;
        rows.push({name,A,B,C,D,E,T,pctAC,pctDE, updated_at:d.updated_at});
        sums.A+=A; sums.B+=B; sums.C+=C; sums.D+=D; sums.E+=E; sums.T+=T;
        if (d.updated_at) lastUpdated = d.updated_at;
      });
      const pctACAll = sums.T? Math.round(((sums.A+sums.B+sums.C)/sums.T)*100) : 0;
      const pctDEAll = sums.T? Math.round(((sums.D+sums.E)/sums.T)*100) : 0;
      return { rows, sums, pctACAll, pctDEAll, units: rows.length, lastUpdated };
    }

    function fillTable(rows){
      const body = document.getElementById('dash-body');
      body.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td class="text-center">${r.A}</td>
          <td class="text-center">${r.B}</td>
          <td class="text-center">${r.C}</td>
          <td class="text-center text-danger-emphasis">${r.D}</td>
          <td class="text-center text-danger">${r.E}</td>
          <td class="text-center fw-semibold">${r.T}</td>
          <td class="text-center text-success">${r.pctAC}%</td>
          <td class="text-center text-danger">${r.pctDE}%</td>`;
        body.appendChild(tr);
      });
    }

    function updateKPI(meta){
      document.getElementById('kpi-units').textContent = meta.units;
      document.getElementById('kpi-ac').textContent = meta.pctACAll + '%';
      document.getElementById('kpi-de').textContent = meta.pctDEAll + '%';
      document.getElementById('kpi-updated').textContent = meta.lastUpdated ? new Date(meta.lastUpdated).toLocaleString('id-ID') : 'â€”';
      document.getElementById('tA').textContent = meta.sums.A;
      document.getElementById('tB').textContent = meta.sums.B;
      document.getElementById('tC').textContent = meta.sums.C;
      document.getElementById('tD').textContent = meta.sums.D;
      document.getElementById('tE').textContent = meta.sums.E;
      document.getElementById('tT').textContent = meta.sums.T;
      document.getElementById('tAC').textContent = meta.pctACAll + '%';
      document.getElementById('tDE').textContent = meta.pctDEAll + '%';
    }

    function buildCharts(rows, sums){
      const labels = rows.map(r=>r.name);
      const dA = rows.map(r=>r.A), dB = rows.map(r=>r.B), dC = rows.map(r=>r.C), dD = rows.map(r=>r.D), dE = rows.map(r=>r.E);

      // Stacked bar per unit
      const ctx1 = document.getElementById('stackedChart');
      if (stackedChart) stackedChart.destroy();
      stackedChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'A', data: dA, backgroundColor: '#22c55e' },
            { label: 'B', data: dB, backgroundColor: '#a3e635' },
            { label: 'C', data: dC, backgroundColor: '#facc15' },
            { label: 'D', data: dD, backgroundColor: '#fb923c' },
            { label: 'E', data: dE, backgroundColor: '#ef4444' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: {
              footer: (items)=>{
                const idx = items[0].dataIndex;
                const tot = rows[idx].T || 0;
                return 'Total: ' + tot;
              }
            }}
          },
          scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
        }
      });

      // Donut A..E total
      const ctx2 = document.getElementById('donutChart');
      if (donutChart) donutChart.destroy();
      donutChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['A','B','C','D','E'],
          datasets: [{
            data: [sums.A, sums.B, sums.C, sums.D, sums.E],
            backgroundColor: ['#22c55e','#a3e635','#facc15','#fb923c','#ef4444']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function exportCSV(){
      const data = readData();
      const units = Object.keys(data).sort();
      let csv = 'Unit,A,B,C,D,E,Total,%A-C,%D-E\\n';
      units.forEach(name => {
        const d = data[name] || {counts:{A:0,B:0,C:0,D:0,E:0}, total:0};
        const A=d.counts.A||0, B=d.counts.B||0, C=d.counts.C||0, D=d.counts.D||0, E=d.counts.E||0;
        const T=A+B+C+D+E || d.total || 0;
        const pctAC = T? Math.round((A+B+C)/T*100) : 0;
        const pctDE = T? Math.round((D+E)/T*100) : 0;
        csv += `"${name}",${A},${B},${C},${D},${E},${T},${pctAC}%,${pctDE}%\\n`;
      });
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'dashboard_grade.csv'; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    function exportPNG(){
      // Gabungkan dua chart ke satu gambar (sederhana: unduh masing-masing)
      const link1 = document.createElement('a');
      link1.href = stackedChart.toBase64Image(); link1.download = 'stacked_per_unit.png'; link1.click();
      setTimeout(()=>{
        const link2 = document.createElement('a');
        link2.href = donutChart.toBase64Image(); link2.download = 'donut_total.png'; link2.click();
      }, 300);
    }

    function applyFilterSearch(rows){
      const q = document.getElementById('searchUnit').value.trim().toLowerCase();
      const cluster = document.getElementById('filterCluster').value;
      return rows.filter(r => {
        const okName = !q || r.name.toLowerCase().includes(q);
        let okCluster = true;
        if (cluster === 'AC') okCluster = (r.pctAC >= r.pctDE);
        if (cluster === 'DE') okCluster = (r.pctDE > r.pctAC);
        return okName && okCluster;
      });
    }

    function sortTableBy(th, rows){
      const type = th.dataset.sort || 'text';
      const idx = Array.from(th.parentElement.children).indexOf(th);
      const dir = (th.dataset.dir === 'asc') ? 'desc' : 'asc';
      th.dataset.dir = dir;
      const factor = dir === 'asc' ? 1 : -1;
      rows.sort((a,b)=>{
        const A = [a.name,a.A,a.B,a.C,a.D,a.E,a.T,a.pctAC,a.pctDE];
        const B = [b.name,b.A,b.B,b.C,b.D,b.E,b.T,b.pctAC,b.pctDE];
        const va = A[idx], vb = B[idx];
        if (type === 'num') return (va - vb) * factor;
        return String(va).localeCompare(String(vb)) * factor;
      });
    }

    function render(){
      const data = readData();
      let {rows, sums, pctACAll, pctDEAll, units, lastUpdated} = compute(data);
      // filter & search
      rows = applyFilterSearch(rows);
      // table & kpi
      fillTable(rows);
      updateKPI({sums, pctACAll, pctDEAll, units: Object.keys(data).length, lastUpdated});
      // charts
      buildCharts(rows, sums);
    }

    document.addEventListener('DOMContentLoaded', () => {
      render();
      document.getElementById('btn-refresh').addEventListener('click', render);
      document.getElementById('btn-export-csv').addEventListener('click', exportCSV);
      document.getElementById('btn-export-png').addEventListener('click', exportPNG);
      document.getElementById('searchUnit').addEventListener('input', render);
      document.getElementById('filterCluster').addEventListener('change', render);

      // Simple sortable headers
      document.querySelectorAll('#tbl thead th').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
          const data = readData();
          let computed = compute(data);
          let rows = computed.rows;
          rows = applyFilterSearch(rows);
          sortTableBy(th, rows);
          fillTable(rows);
          buildCharts(rows, computed.sums);
        });
      });
    });
  </script>
</body>
</html>
